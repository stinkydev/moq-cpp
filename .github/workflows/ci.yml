name: Build and Test

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

jobs:
  build:
    strategy:
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]
        
    runs-on: ${{ matrix.os }}
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Install Rust
      uses: dtolnay/rust-toolchain@stable
      
    - name: Cache Rust dependencies
      uses: actions/cache@v4
      with:
        path: |
          ~/.cargo/registry
          ~/.cargo/git
          build/rust-target
        key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}
        restore-keys: |
          ${{ runner.os }}-cargo-
      
    - name: Install CMake
      uses: lukka/get-cmake@latest
      
    - name: Install Ninja (Ubuntu)
      if: runner.os == 'Linux'
      run: sudo apt-get update && sudo apt-get install -y ninja-build
      
    - name: Install Ninja (macOS)
      if: runner.os == 'macOS'
      run: brew install ninja
      
    - name: Configure CMake
      run: cmake -B build -DCMAKE_BUILD_TYPE=Release
      
    - name: Debug headers before build
      run: |
        echo "Current working directory:"
        pwd
        echo "C++ headers in cpp/include/:"
        ls -la cpp/include/ || echo "C++ headers not found"
        echo "Checking if directories exist:"
        test -d cpp/include && echo "cpp/include exists" || echo "cpp/include missing"
        echo "Full cpp/include structure:"
        find cpp/include -type f -name "*.h" || echo "No header files found"
        echo "Cargo.toml location:"
        ls -la Cargo.toml || echo "Cargo.toml not found"
      shell: bash
      
    - name: Build Rust library first (Ubuntu)
      if: runner.os == 'Linux'
      run: |
        echo "Building Rust library..."
        cargo build --release
        echo "Rust build completed, checking output:"
        ls -la build/rust-target/release/ || echo "No Rust output found"
      
    - name: Build
      run: cmake --build build --parallel
      
    - name: Install library for testing
      run: |
        cd build
        cmake --install . --prefix ../install
      
    - name: Build examples against installed library
      run: |
        cd examples
        cmake -B example-build -DCMAKE_BUILD_TYPE=Release -DCMAKE_PREFIX_PATH=../install
        cmake --build example-build --parallel
        
        echo "Examples built against installed library:"
        ls -la example-build/
      
    - name: List build artifacts
      run: |
        echo "Build directory contents:"
        ls -la build/
        echo "Rust target contents:"
        find build/rust-target -name "*moq_wrapper*" || echo "No moq_wrapper files found"
        echo "Installed library structure:"
        find install -type f | head -20 || echo "No installation found"
        echo "Example build results:"
        find examples/example-build -name "clock_*" -o -name "*.exe" | head -10 || echo "No examples found"
      shell: bash
      
    - name: Test
      run: |
        echo "=== Testing library installation ==="
        echo "Checking installed files:"
        find install -type f | head -20
        
        echo "=== Testing examples built against installed library ==="
        cd examples/example-build
        echo "Contents of example build directory:"
        ls -la
        
        if [[ "$RUNNER_OS" == "Windows" ]]; then
          if [ -f "./clock_publisher_example.exe" ] && [ -f "./clock_subscriber_example.exe" ]; then
            echo "✅ Windows examples built successfully"
          elif [ -f "./Release/clock_publisher_example.exe" ] && [ -f "./Release/clock_subscriber_example.exe" ]; then
            echo "✅ Windows examples built successfully (Release)"
          elif [ -f "./Debug/clock_publisher_example.exe" ] && [ -f "./Debug/clock_subscriber_example.exe" ]; then
            echo "✅ Windows examples built successfully (Debug)"
          else
            echo "❌ ERROR: Example executables not found"
            exit 1
          fi
        else
          if [ -f "./clock_publisher_example" ] && [ -f "./clock_subscriber_example" ]; then
            echo "✅ Unix examples built successfully"
          else
            echo "❌ ERROR: Example executables not found"
            exit 1
          fi
        fi
        
        echo "✅ All verification tests completed successfully!"
        echo "✅ CMake export configuration works correctly!"
        echo "✅ Examples can be built as separate projects using find_package!"
      shell: bash

  rust-tests:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Install Rust
      uses: dtolnay/rust-toolchain@stable
      with:
        components: rustfmt, clippy
        
    - name: Cache Rust dependencies
      uses: actions/cache@v4
      with:
        path: |
          ~/.cargo/registry
          ~/.cargo/git
          build/rust-target
        key: ubuntu-cargo-${{ hashFiles('**/Cargo.lock') }}
        restore-keys: |
          ubuntu-cargo-
      
    - name: Run Rust tests
      run: cargo test --lib --tests
      
    - name: Check Rust formatting
      run: cargo fmt --check
      
    - name: Run Clippy
      run: cargo clippy -- -D clippy::correctness -D clippy::complexity -D clippy::perf -D clippy::not_unsafe_ptr_arg_deref -A clippy::missing_safety_doc
